import { ExtensionPlugin, Identifier, Presence } from '@big-sister'
import createLogger from '@big-sister/logging'
import { Observable } from 'rxjs'

const log = createLogger('extension-map-identifiers')

/**
 * Maps the identities provided by the spy.
 */
const plugin: ExtensionPlugin<Options> = async (options) => {
  const { identifierMap } = options
  return {
    transformPresence(presence$: Observable<Presence>): Observable<Presence> {
      return presence$.map(presence => {
        const { presentIdentifiers, timestamp } = presence
        const mappedIdentifiers: Identifier[] = []
        for (const identifier of presentIdentifiers) {
          const mappedIdentifier = identifierMap[identifier]
          if (mappedIdentifier) {
            log.verbose(`Mapping '${identifier}' to '${mappedIdentifier}'`)
            mappedIdentifiers.push(mappedIdentifier)
          } else {
            log.verbose(`No match for '${identifier}'`)
          }
        }
        return { presentIdentifiers: mappedIdentifiers, timestamp }
      })
    },
  }
}

export default plugin

interface Options {

  /**
   * Maps from source identitifiers to destination identifiers.
   */
  identifierMap: { [identifier: string]: Identifier }
}
