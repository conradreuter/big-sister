import { Identifier, PresenceInterval, StorePlugin } from '@big-sister'
import createLogger from '@big-sister/logging'

const log = createLogger('store-memory')

/**
 * Stores presence information in memory for testing purposes.
 */
const plugin: StorePlugin<{}> = async (options) => {
  log.warn('Do not use the in-memory store in production!')
  const cache = new Map<Identifier, PresenceInterval[]>()
  return {
    async becomeAbsent(identifier, timestamp) {
    },
    async becomePresent(identifier, timestamp) {
      let intervals = cache.get(identifier)
      if (!intervals) cache.set(identifier, intervals = [])
      intervals.unshift({ from: timestamp, to: timestamp })
    },
    async stayPresent(identifier, timestamp) {
      const intervals = cache.get(identifier)!
      intervals[0].to = timestamp
    },
  }
}

export default plugin

