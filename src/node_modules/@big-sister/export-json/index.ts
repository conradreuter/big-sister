import { ExportPlugin, PastPresence } from '@big-sister'
import createLogger from '@big-sister/logging'
import { sumBy } from 'lodash'

const log = createLogger('export-json')

/**
 * Export the presence information as JSON.
 */
const plugin: ExportPlugin<{}> = async (options) => {
  return {
    generate,
    fileExtension: 'json',
    mimeType: 'application/json',
  }

  async function generate(presences: PastPresence[]): Promise<Buffer> {
    log.verbose(`Exporting ${sumBy(presences, 'intervals.length')} entries as JSON`)
    return Buffer.from(JSON.stringify(presences, null, 2))
  }
}

export default plugin

