import { ExtensionPlugin, Identifier, Presence } from '@big-sister'
import createLogger from '@big-sister/logging'
import { Observable } from 'rxjs'

const log = createLogger('extension-distinct-identifiers')

/**
 * Makes the identifiers provided by the spy distinct.
 */
const plugin: ExtensionPlugin<{}> = async (options) => {
  return {
    transformPresence(presence$: Observable<Presence>): Observable<Presence> {
      return presence$.map(presence => {
        const { presentIdentifiers, timestamp } = presence
        const distinctIdentifiers = new Set<string>()
        for (const identifier of presentIdentifiers) {
          distinctIdentifiers.add(identifier)
        }
        log.verbose(`Removed ${presentIdentifiers.length - distinctIdentifiers.size} duplicate identifiers`)
        return { presentIdentifiers: [...distinctIdentifiers], timestamp }
      })
    },
  }
}

export default plugin

