import { Export, PluginConfiguration } from '@big-sister'
import { snakeCase } from 'lodash'
import loadPlugin from './utility/loadPlugin'
import log from './utility/logging'

export default async function loadExports(
  configurations: { [name: string]: PluginConfiguration<any> },
): Promise<{ [key: string]: Export }> {
  log.verbose(`Loading ${configurations.length} export(s)...`)
  const exports: { [name: string]: Export } = {}
  for (const [name, configuration] of Object.entries(configurations)) {
    const key = snakeCase(name).toUpperCase()
    log.verbose(`Loading export '${configuration.plugin}' as '${key}'...`)
    const exportt = await loadPlugin(configuration.plugin, 'export')(configuration.options)
    exports[key] = Object.assign(exportt, { name })
  }
  return exports
}
