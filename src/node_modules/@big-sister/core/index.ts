require('source-map-support').install({
  environment: 'node',
  handleUncaughtExceptions: false,
})

import { Identifier } from '@big-sister'
import { setLogLevel } from '@big-sister/logging'
import loadConfiguration from './loadConfiguration'
import loadExtensions from './loadExtensions'
import loadSpy from './loadSpy'
import loadStore from './loadStore'
import startCollector from './startCollector'
import startServer from './startServer'
import stitchSchema from './stitchSchema'

start()

async function start() {
  const configuration = await loadConfiguration()
  setLogLevel(configuration.logLevel)
  const spy = await loadSpy(configuration.spy)
  const store = await loadStore(configuration.store)
  const extensions = await loadExtensions(configuration.extensions)
  const schema = stitchSchema(store, extensions)
  startCollector(spy, store, extensions)
  startServer(configuration.server, schema)
}
