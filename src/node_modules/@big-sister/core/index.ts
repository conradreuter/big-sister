require('source-map-support').install({
  environment: 'node',
  handleUncaughtExceptions: false,
})

import { Identifier } from '@big-sister'
import { setLogLevel } from '@big-sister/logging'
import startServer from './api/startServer'
import stitchSchema from './api/stitchSchema'
import createCollector from './system/createCollector'
import loadConfiguration from './system/loadConfiguration'
import loadExports from './system/loadExports'
import loadExtensions from './system/loadExtensions'
import loadSpy from './system/loadSpy'
import loadStore from './system/loadStore'

start()

async function start() {
  const configuration = await loadConfiguration()
  setLogLevel(configuration.logLevel)
  const collector = createCollector()
  const spy = await loadSpy(configuration.spy)
  const store = await loadStore(configuration.store)
  const extensions = await loadExtensions(configuration.extensions, collector, spy, store)
  const exports = await loadExports(configuration.exports)
  const schema = stitchSchema(collector, spy, store, extensions, exports)
  startServer(configuration.server, schema)
  collector.start(spy, store, extensions)
}
