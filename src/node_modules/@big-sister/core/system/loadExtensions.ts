import { Collector, Extension, PluginConfiguration, Spy, Store } from '@big-sister'
import loadPlugin from '../utility/loadPlugin'
import log from '../utility/logging'

const EXTENSION_DEFAULTS: Extension = {
  transformPresence: presence$ => presence$
}

export default async function loadExtensions(
  configurations: PluginConfiguration<any>[],
  collector: Collector,
  spy: Spy,
  store: Store,
): Promise<Extension[]> {
  log.verbose(`Loading ${configurations.length} extension(s)...`)
  const extensions = []
  for (const configuration of configurations) {
    log.verbose(`Loading extension '${configuration.plugin}'...`)
    const extensionPlugin = loadPlugin(configuration.plugin, 'extension')
    const extension = await extensionPlugin(configuration.options, collector, spy, store)
    extensions.push({ ...EXTENSION_DEFAULTS, ...extension })
  }
  return extensions
}
