import { Configuration } from '@big-sister'
import { LOG_LEVELS } from '@big-sister/logging'
import * as fs from 'fs'
import { promisify } from 'util'
import log from './utility/logging'

const CONFIG_FILE = 'big-sister.config.json'

const DEFAULT_CONFIGURATION: Configuration = {
  extensions: [],
  logLevel: 'warn',
  spy: { options: {}, plugin: 'mock' },
  store: { options: {}, plugin: 'memory' },
}

export default async function loadConfiguration(): Promise<Configuration> {
  const config = { ...DEFAULT_CONFIGURATION }
  try {
    const configFileContent = await promisify(fs.readFile)(CONFIG_FILE)
    Object.assign(config, JSON.parse(configFileContent.toString()))
  } catch (err) {
    log.error(`Error loading configuration file ${CONFIG_FILE}: ${err.stacktrace || err}`)
  }
  return config
}
