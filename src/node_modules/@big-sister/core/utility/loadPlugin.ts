import { ExportPlugin, ExtensionPlugin, SpyPlugin, StorePlugin } from '@big-sister'
import log from './logging'

export default function loadPlugin(pluginName: string, type: 'export'): ExportPlugin<any>
export default function loadPlugin(pluginName: string, type: 'extension'): ExtensionPlugin<any>
export default function loadPlugin(pluginName: string, type: 'spy'): SpyPlugin<any>
export default function loadPlugin(pluginName: string, type: 'store'): StorePlugin<any>
export default function loadPlugin(pluginName: string, type: string): any {
  const possibleModuleNames = [
    `@big-sister/${type}-${pluginName}`,
    pluginName
  ]
  log.verbose(`Resolving plugin '${pluginName}'...`)
  for (const moduleName of possibleModuleNames) {
    if (!moduleExists(moduleName)) {
      log.verbose(`Module '${moduleName}' not found`)
      continue
    }
    log.verbose(`Plugin '${pluginName}' has been resolved to module '${moduleName}'`)
    log.info(`Loading plugin '${moduleName}'`)
    return require(moduleName).default
  }
  log.fatal(`Unable to find plugin '${pluginName}'. Please make sure it is installed`)
}

function moduleExists(moduleName: string): boolean {
  try {
    require.resolve(moduleName)
    return true
  } catch {
    return false
  }
}
