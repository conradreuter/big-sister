<template>
  <q-pull-to-refresh :handler="refresh">
    <q-list link no-border>
      <q-list-header>{{ $t('home') }}</q-list-header>
      <q-item v-for="(isPresent, identifier) in presence" :key="identifier">
        <q-item-side left>
          <q-item-tile
            :color="isPresent ? 'green' : 'grey'"
            :icon="isPresent ? 'check circle' : 'cancel'"
          />
        </q-item-side>
        <q-item-main>{{ identifier }}</q-item-main>
      </q-item>
    </q-list>
  </q-pull-to-refresh>
</template>

<script>
import gql from 'graphql-tag'
import {
  QItem,
  QItemMain,
  QItemSide,
  QItemTile,
  QList,
  QListHeader,
  QPullToRefresh,
} from 'quasar-framework'

export default {
  name: 'Home',
  components: {
    QItem,
    QItemMain,
    QItemSide,
    QItemTile,
    QList,
    QListHeader,
    QPullToRefresh,
  },
  apollo: {
    allIdentifiers: {
      query: gql`{
        allIdentifiers: knownIdentifiers
      }`,
    },
    presentIdentifiers: {
      query: gql`{
        presentIdentifiers: currentPresence
      }`,
      pollInterval: 30000,
    },
  },
  computed: {
    presence() {
      const tmp = {}
      for (let identifier of this.allIdentifiers || []) {
        tmp[identifier] = false
      }
      for (let identifier of this.presentIdentifiers || []) {
        tmp[identifier] = true
      }
      const presence = {}
      for (let identifier of Object.keys(tmp).sort()) {
        presence[identifier] = tmp[identifier]
      }
      return presence
    },
  },
  methods: {
    async refresh(done) {
      await this.$apollo.queries.presentIdentifiers.refetch()
      done()
    },
  },
}
</script>

<style>
</style>
