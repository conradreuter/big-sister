import { ExtensionPlugin, Identifier, Presence } from '@big-sister'
import { Observable } from 'rxjs'

/**
 * Makes the identifiers provided by the spy distinct.
 */
const plugin: ExtensionPlugin<{}> = async (options) => {
  return {
    transformPresence(presence$: Observable<Presence>): Observable<Presence> {
      return presence$.map(presence => {
        const { presentIdentifiers, timestamp } = presence
        const distinctIdentifiers = new Set<string>()
        for (const identifier of presentIdentifiers) {
          distinctIdentifiers.add(identifier)
        }
        return { presentIdentifiers: [...distinctIdentifiers], timestamp }
      })
    },
  }
}

export default plugin

