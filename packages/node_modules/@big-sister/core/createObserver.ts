import { Extension, Identifier, Spy, Store } from '@big-sister/types'

export default function createObserver(
  spy: Spy,
  store: Store,
  extensions: Extension[],
): Observer {
  const cache = new Map<Identifier, boolean>()
  const presence$ = extensions.reduce((p$, e) => e.transformPresence(p$), spy.presence$)
  return {
    start() {
      presence$.subscribe(async presence => {
        const { presentIdentifiers, timestamp } = presence
        const absentIdentifiers = new Set(cache.keys())
        await Promise.all(presentIdentifiers.map(async identifier => {
          if (cache.has(identifier)) {
            await store.stayPresent(identifier, timestamp)
            absentIdentifiers.delete(identifier)
          } else {
            await store.becomePresent(identifier, timestamp)
            cache.set(identifier, true)
          }
        }))
        await Promise.all([...absentIdentifiers].map(async identifier => {
          await store.becomeAbsent(identifier, timestamp)
          cache.set(identifier, false)
        }))
      })
    }
  }
}

interface Observer {

  /**
   * Start watching for presence changes and store them.
   */
  start(): void
}
