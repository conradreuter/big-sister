import { ExtensionPlugin, Identifier, Presence } from '@big-sister'
import { Observable } from 'rxjs'

/**
 * Maps the identities provided by the spy.
 */
const plugin: ExtensionPlugin<Options> = async (options) => {
  const { identifierMap } = options
  return {
    transformPresence(presence$: Observable<Presence>): Observable<Presence> {
      return presence$.map(presence => {
        const { presentIdentifiers, timestamp } = presence
        const mappedIdentifiers = (
          presentIdentifiers
            .map(identifier => identifierMap[identifier])
            .filter(identifier => !!identifier)
        )
        return { presentIdentifiers: mappedIdentifiers, timestamp }
      })
    },
  }
}

export default plugin

interface Options {

  /**
   * Maps from source identitifiers to destination identifiers.
   */
  identifierMap: { [identifier: string]: Identifier }
}
