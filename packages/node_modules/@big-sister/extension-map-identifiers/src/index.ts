import { ExtensionPlugin, Identifier, Presence } from '@big-sister/types'
import { Observable } from 'rxjs'

/**
 * Maps the identities provided by the spy.
 */
const plugin: ExtensionPlugin<Options> = async (options) => {
  const { identifierMap } = options
  return { transformPresence }

  function transformPresence(presence$: Observable<Presence>): Observable<Presence> {
    return presence$.map(presence => (
      presence
        .map(identifier => identifierMap[identifier])
        .filter(identifier => !!identifier)
    ))
  }
}

export default plugin

interface Options {

  /**
   * Maps from source identitifiers to destination identifiers.
   */
  identifierMap: { [identifier: string]: Identifier }
}
